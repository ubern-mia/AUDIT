# Post-processing model predictions with AUDIT

In this tutorial we will see how users can clean, organize and prepare their model's outputs for using AUDIT to 
analyze the results.

Let's assume we've selected a pre-trained model from an open-source repository to generate predictions on your 
dataset. It is likely that the model wasn’t trained to predict the same labels that our segmentations use. In such 
cases, we’ll need to apply some post-processing to properly evaluate these predictions using AUDIT.

Fortunately, AUDIT provides users with tools to perform this post-processing and adapt the predictions as needed. 
Let’s walk through how to do this.



## 1. Load functions

This tutorial uses some utility functions from the `src.utils.operations.file_operations` and `src.utils.sequences` 
modules to manipulate files and sequences.

```python
import os
from src.utils.operations.file_operations import (
    ls_dirs, 
    ls_files, 
    rename_files, 
    rename_directories, 
    delete_files_by_extension, 
    organize_files_into_folders, 
    add_suffix_to_files
)
from src.utils.sequences import (
    read_sequences_dict, 
    iterative_labels_replacement, 
    load_nii, 
    load_nii_by_id, 
    count_labels
)
```

## 2. Data understanding

Now, let's suppose we have a model that was trained on a brain MRI dataset that we don't know in advance (in this case, it was BraTS2020). We use this model to generate a series of predictions on our own dataset. In our scenario, we want to run inference on BraTS2024 Pediatrics.

After running the inference, we store the predictions in the following directory:

```python
# Define paths and folder names
root_path = "/home/user/AUDIT/datasets/BraTS2024_PED/BraTS2024_PED_seg/"
```

Let's check what is stored in the specified directory:

```python
ls_files(root_path)[:6]
```

```python
['BraTS2024_PED-00001-000.nii.gz', 
'BraTS2024_PED-00001-000_ground_truth.nii.gz', 
'BraTS2024_PED-00001-000_segmentation.nii.gz', 
'BraTS2024_PED-00001-000_sequences.npy', 
'BraTS2024_PED-00002-000.nii.gz',
 'BraTS2024_PED-00002-000_ground_truth.nii.gz']
```

As we can see, for some reason, the authors who designed this model not only stored the predictions but also saved 
additional files.

```python
file_1 = load_nii(path_folder=os.path.join(root_path, 'BraTS2024_PED-00001-000.nii.gz'), as_array=True)
file_2 = load_nii(path_folder=os.path.join(root_path, 'BraTS2024_PED-00001-000_segmentation.nii.gz'), as_array=True)
file_3 = load_nii(path_folder=os.path.join(root_path, 'BraTS2024_PED-00001-000_ground_truth.nii.gz'), as_array=True)

print(file_1.shape)
print(file_2.shape)
print(file_3.shape)
```

```
(155, 240, 240)
(160, 224, 160)
(160, 224, 160)
```

## 3. Remove unnecessary data

In this case, the developers of the model conducted other experiments during inference by modifying the original 
dimensions of the images (155, 240, 240). As a result, all the files ending with "_ground_truth," "segmentation," and 
"_sequences" are unnecessary for our purposes and should be deleted.

To accomplish this, we can utilize a function from AUDIT called _delete_files_by_extension_. This function allows us to 
repeatedly delete files from a directory based on their file extension.

Here’s how to use it:

```python
delete_files_by_extension(root_dir=root_path, ext="npy", verbose=True)
```

```
Deleted file: /home/user/AUDIT/datasets/BraTS2024_PED/BraTS2024_PED_seg/BraTS2024_PED-00088-000_sequences.npy
Deleted file: /home/user/AUDIT/datasets/BraTS2024_PED/BraTS2024_PED_seg/BraTS2024_PED-00141-000_sequences.npy
Deleted file: /home/user/AUDIT/datasets/BraTS2024_PED/BraTS2024_PED_seg/BraTS2024_PED-00239-000_sequences.npy
...
...
```

We can confirm that all files with the specified extensions have been successfully deleted from the directory. 
```python
ls_files(root_path)[:6]
```

```
['BraTS2024_PED-00001-000.nii.gz', 
'BraTS2024_PED-00001-000_ground_truth.nii.gz', 
'BraTS2024_PED-00001-000_segmentation.nii.gz', 
'BraTS2024_PED-00002-000.nii.gz',
'BraTS2024_PED-00002-000_ground_truth.nii.gz'
'BraTS2024_PED-00002-000_segmentation.nii.gz']
```

Now, let's proceed to remove the rest of the unnecessary files as well. We will apply the same 
_delete_files_by_extension_ function to eliminate any remaining files that we do not need.


## 4. Organize folder

AUDIT is designed to work with multiple models and datasets, but it requires a specific organization of the data for 
processing. Currently, we have a single directory "/home/user/AUDIT/datasets/BraTS2024_PED/BraTS2024_PED_seg/" 

This directory contains the predictions generated by a computer vision model for the BraTS2024 Pediatrics dataset. 
However, AUDIT requires that each segmentation be contained within a folder named after the subject ID. Since users may not structure their code to produce output in this specific format—like the pre-trained model we are 
using—AUDIT provides functions to facilitate the organization of files.

In this case, we can use the organize_files_into_folders function to create the necessary data structure without 
needing to perform complex manipulations.



```python
organize_files_into_folders(root_path, extension='.nii.gz', verbose=True)

print(ls_files(root_path)[:6])
print(ls_dirs(root_path)[:6])
```

```
[]

['BraTS2024_PED-00001-000',
 'BraTS2024_PED-00002-000',
 'BraTS2024_PED-00003-000',
 'BraTS2024_PED-00004-000',
 'BraTS2024_PED-00005-000'
 'BraTS2024_PED-00006-000']
```

As can be seen, the structure of the directory containing the predictions has changed. Instead of having all the files 
scattered within the directory, a separate folder has been created for each subject, containing their respective 
predictions. 

This organized structure makes it much easier to manage and process the predictions for each subject in the dataset. 
Let’s take a moment to verify this new organization:

```
|--BraTS2024_PED-00001-000
|---- BraTS2024_PED-00001-000.nii.gz
|--BraTS2024_PED-00002-000
|---- BraTS2024_PED-00002-000.nii.gz
...
|--BraTS2024_PED-00266-000
|---- BraTS2024_PED-00266-000.nii.gz
```


## 5. Add extension name


Another important aspect of AUDIT is that it uses file extensions to distinguish between sequences (e.g., _t1, _t2, 
_t1ce, _flair), segmentations (_seg), and predictions (_pred`). However, if we recall the names of the files 
generated after inference, they did not contain any specific nomenclature (i.e. BraTS2024_PED-00001-000.nii.gz).

To simplify the task for users and eliminate the need to modify their pipelines to ensure compatibility with AUDIT, 
the library provides methods to quickly and easily adapt the file names. 

Let’s explore how to rename the files so they align with AUDIT’s requirements. Taking advantage of the function 
_add_suffix_to_files_, we can add the extension requered by AUDIT.

```python
add_suffix_to_files(folder_path=root_path, suffix='_pred', ext='.nii.gz', verbose=True)
```

Now, all the files within the root_path contain the _pred extension.

```python
ls_files(os.path.join(root_path, 'BraTS2024_PED-00001-000'))
```

```
['BraTS2024_PED-00001-000_pred.nii.gz']
```


## 6. Label replacement


Last but not least, we need to verify which labels were generated after the inference. As mentioned, the model used 
was pre-trained on the BraTS2020 dataset to predict the labels ENH, NEC, and EDE. However, these may not align with the 
labels used in the BraTS2024 Pediatrics dataset. In fact, they are different and will need to be adjusted accordingly.

Let’s check the generated labels and discuss how to adapt them to match the required labels for the BraTS2024 
Pediatrics dataset.


```python
pred = load_nii_by_id(root=root_path, patient_id='BraTS2024_PED-00001-000', seq="_pred", as_array=True)
count_labels(pred)
```

```
{0.0: 7664276, 1.0: 106230, 2.0: 325915, 4.0: 831579}
```

As we discussed earlier, the labels used in BraTS2020 are [0, 4, 1, 2] for the labels ENH, NEC, and EDE, respectively. 
In contrast, the labels for BraTS2024 Pediatrics are [0, 1, 2, 3] for the same categories.

To resolve this mismatch, we will use the iterative_labels_replacement function. This function takes the old mapping 
and the new mapping as parameters and replaces the labels accordingly.

```python
# old mappings
brats2020_mapping = [0, 4, 1, 2]
# new mapping
new_mapping = [0, 1, 2, 3]

iterative_labels_replacement(
    root_dir=root_path, 
    original_labels=brats2020_mapping, 
    new_labels=new_mapping,
    ext='pred',
    verbose=True
)
```

Once we apply this function, we can confirm that the labels are now correct.

```python
pred = load_nii_by_id(root=root_path, patient_id='BraTS2024_PED-00001-000', seq="_pred", as_array=True)
count_labels(pred)
```

```
{0.0: 7664276, 1.0: 831579, 2.0: 106230, 3.0: 325915}
```


Additionally, by comparing the labels from the predictions with those from the original segmentation, we can see that 
both use the range from 0 to 3.

```python
seg = load_nii_by_id(
    root="/home/carlos/Documentos/proyectos/AUDIT/datasets/BraTS2024_PED/BraTS2024_PED_images/", 
    patient_id='BraTS2024_PED-00001-000', 
    seq="_seg", 
    as_array=True
)

count_labels(seg)
```

```
{0: 8799333, 1: 6204, 2: 87918, 3: 34545}
```

Finally, we have prepared the dataset to run the metric_extractor.py module and start using AUDIT effectively.